<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elemental Duo - Ultra Smooth Multiplayer Edition</title>
    <meta name="description" content="Play Elemental Duo online with friends - 15 cooperative puzzle levels">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: white;
        }

        .connection-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
        }

        .connection-form {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 90%;
        }

        .connection-form h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .form-group {
            margin: 20px 0;
        }

        .form-group input {
            padding: 15px;
            font-size: 16px;
            border: none;
            border-radius: 10px;
            width: 100%;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
            transform: scale(1.02);
        }

        .btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4);
            background: linear-gradient(45deg, #ff5252, #d63031);
        }

        .status-message {
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .player-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 15px;
            z-index: 1500;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(78, 205, 196, 0.3);
        }

        .network-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1500;
            font-size: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .game-header {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(15px);
            border-bottom: 2px solid rgba(78, 205, 196, 0.3);
        }

        .game-header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.5);
        }

        .controls {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }

        .player-controls {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(5px);
            margin: 5px;
            transition: all 0.3s ease;
        }

        .my-controls {
            border: 2px solid #4ecdc4;
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.4);
            background: rgba(78, 205, 196, 0.2);
        }

        #gameCanvas {
            flex: 1;
            background: linear-gradient(180deg, #87ceeb, #98fb98);
            border: 3px solid #333;
            display: block;
            margin: 0 auto;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .game-info {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(15px);
            border-top: 2px solid rgba(78, 205, 196, 0.3);
            font-size: 0.9em;
        }

        .level-complete {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            display: none;
            z-index: 1000;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .level-complete h2 {
            margin-bottom: 15px;
            font-size: 2em;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        @media (max-width: 768px) {
            .game-header h1 {
                font-size: 1.8em;
            }
            
            .controls {
                font-size: 0.8em;
            }
            
            .connection-form {
                padding: 30px 20px;
            }
            
            .connection-form h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <!-- Connection Screen -->
    <div id="connectionScreen" class="connection-screen">
        <div class="connection-form">
            <h1>üî•üíß Elemental Duo üíßüî•</h1>
            <p style="margin-bottom: 20px; opacity: 0.9;">Ultra Smooth Multiplayer Edition<br>15 Cooperative Puzzle Levels</p>
            
            <div class="form-group">
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20" autocomplete="off">
            </div>
            
            <div class="form-group">
                <input type="text" id="roomId" placeholder="Room ID (or create new)" maxlength="20" autocomplete="off">
            </div>
            
            <button class="btn" onclick="window.joinGame()">üö™ Join Game</button>
            <button class="btn" onclick="window.createRoom()">üÜï Create Room</button>
            
            <div class="status-message" id="statusMessage">
                Enter your name and room ID to start your cooperative adventure!
            </div>
        </div>
    </div>

    <!-- Network Info -->
    <div id="networkInfo" class="network-info" style="display: none;">
        <div>Ping: <span id="pingValue">--</span>ms</div>
        <div>FPS: <span id="fpsValue">--</span></div>
    </div>

    <!-- Player Indicator -->
    <div id="playerIndicator" class="player-indicator" style="display: none;">
        <div id="playerInfo"></div>
        <div id="roomInfo"></div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" style="display: none;">
        <div class="game-header">
            <h1>üî•üíß Elemental Duo üíßüî•</h1>
            <div class="controls">
                <div class="player-controls" id="fireControls">
                    <strong>üî• Fire Player:</strong> WASD to move
                </div>
                <div class="player-controls" id="waterControls">
                    <strong>üíß Water Player:</strong> Arrow Keys to move
                </div>
            </div>
        </div>

        <canvas id="gameCanvas" width="1000" height="600"></canvas>

        <div class="game-info">
            <span id="levelInfo">Level 1 - Get both players to their colored doors!</span>
            <span style="margin-left: 30px;">üî• Fire Player ‚Üí Red Door | üíß Water Player ‚Üí Blue Door | Activate all switches and reach doors together!</span>
        </div>

        <div id="levelComplete" class="level-complete">
            <h2>üéâ Level Complete! üéâ</h2>
            <p id="levelCompleteText">Excellent teamwork! Ready for the next challenge?</p>
            <button class="btn" onclick="window.nextLevel()">‚û°Ô∏è Next Level</button>
            <button class="btn" onclick="window.restartLevel()">üîÑ Restart Level</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        console.log("üéÆ Elemental Duo - Ultra Smooth Edition v4.0 Loading...");
        
        // IMPROVED NETWORKING WITH CLIENT-SIDE PREDICTION
        let socket = null;
        let myPlayerType = null;
        let gameInitialized = false;
        let sequenceNumber = 0;
        let lastPingTime = 0;
        let ping = 0;
        
        // Performance monitoring
        let lastFrameTime = performance.now();
        let frameCount = 0;
        let fps = 60;

        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let currentLevel = 1;
        let gameState = 'playing';

        // IMPROVED PLAYER OBJECTS WITH PREDICTION
        let myPlayer = {
            x: 50, y: 522, width: 28, height: 28, color: '#ff4757',
            speed: 4, maxSpeed: 6, velX: 0, velY: 0, acceleration: 0.5,
            friction: 0.8, jumpPower: 14, gravity: 0.6, maxFallSpeed: 12,
            jumping: false, onGround: false, onWall: false,
            keys: { left: false, right: false, up: false },
            // Prediction state
            serverState: { x: 50, y: 522, velX: 0, velY: 0, timestamp: 0 },
            stateBuffer: [] // Buffer for reconciliation
        };

        let otherPlayer = {
            x: 100, y: 522, width: 28, height: 28, color: '#3742fa',
            speed: 4, maxSpeed: 6, velX: 0, velY: 0, acceleration: 0.5,
            friction: 0.8, jumpPower: 14, gravity: 0.6, maxFallSpeed: 12,
            jumping: false, onGround: false, onWall: false,
            keys: { left: false, right: false, up: false },
            // Interpolation state
            targetState: { x: 100, y: 522, velX: 0, velY: 0, timestamp: 0 },
            interpolationBuffer: [],
            lastUpdateTime: 0
        };

        // Input buffer for client-side prediction
        let inputBuffer = [];
        let lastInputSent = 0;
      
      const levels = [
            // Level 1: Tutorial - Basic movement and doors
            {
                name: "First Steps",
                platforms: [
                    { x: 0, y: 550, width: 1000, height: 50, color: '#8b4513' },
                    { x: 200, y: 450, width: 150, height: 20, color: '#8b4513' },
                    { x: 450, y: 380, width: 150, height: 20, color: '#8b4513' },
                    { x: 700, y: 320, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 300, y: 530, width: 80, height: 20, type: 'water', color: '#0074d9' },
                    { x: 600, y: 530, width: 80, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 750, y: 270, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 815, y: 270, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: []
            },
            
            // Level 2: Switch introduction
            {
                name: "Learning Switches",
                platforms: [
                    { x: 0, y: 550, width: 1000, height: 50, color: '#8b4513' },
                    { x: 150, y: 450, width: 100, height: 20, color: '#8b4513' },
                    { x: 350, y: 400, width: 100, height: 20, color: '#8b4513' },
                    { x: 550, y: 350, width: 100, height: 20, color: '#8b4513' },
                    { x: 750, y: 300, width: 200, height: 20, color: '#8b4513' },
                    { x: 400, y: 200, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 270, y: 530, width: 60, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 470, y: 530, width: 60, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 450, y: 150, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 150, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 200, y: 430, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 800, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 3: Bridge cooperation
            {
                name: "Bridge Building",
                platforms: [
                    { x: 0, y: 550, width: 150, height: 50, color: '#8b4513' },
                    { x: 250, y: 480, width: 80, height: 20, color: '#8b4513' },
                    { x: 400, y: 420, width: 80, height: 20, color: '#8b4513' },
                    { x: 550, y: 360, width: 80, height: 20, color: '#8b4513' },
                    { x: 700, y: 300, width: 80, height: 20, color: '#8b4513' },
                    { x: 850, y: 550, width: 150, height: 50, color: '#8b4513' },
                    { x: 400, y: 200, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 170, y: 530, width: 60, height: 20, type: 'water', color: '#0074d9' },
                    { x: 330, y: 460, width: 50, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 480, y: 400, width: 50, height: 20, type: 'water', color: '#0074d9' },
                    { x: 630, y: 340, width: 50, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 450, y: 150, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 150, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 50, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 750, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' }
                ]
            },
            
            // Level 4: Elevator mechanics
            {
                name: "Rising Together",
                platforms: [
                    { x: 0, y: 550, width: 120, height: 50, color: '#8b4513' },
                    { x: 180, y: 480, width: 60, height: 20, color: '#8b4513' },
                    { x: 300, y: 420, width: 60, height: 20, color: '#8b4513' },
                    { x: 420, y: 360, width: 60, height: 20, color: '#8b4513' },
                    { x: 540, y: 300, width: 60, height: 20, color: '#8b4513' },
                    { x: 660, y: 240, width: 60, height: 20, color: '#8b4513' },
                    { x: 780, y: 180, width: 120, height: 20, color: '#8b4513' },
                    { x: 400, y: 120, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 140, y: 530, width: 30, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 260, y: 460, width: 30, height: 20, type: 'water', color: '#0074d9' },
                    { x: 380, y: 400, width: 30, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 500, y: 340, width: 30, height: 20, type: 'water', color: '#0074d9' },
                    { x: 620, y: 280, width: 30, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 450, y: 70, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 70, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 60, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 210, y: 460, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 570, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 5: Split paths
            {
                name: "Divided Paths",
                platforms: [
                    { x: 0, y: 550, width: 100, height: 50, color: '#8b4513' },
                    { x: 150, y: 480, width: 50, height: 20, color: '#8b4513' },
                    { x: 250, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 350, y: 360, width: 50, height: 20, color: '#8b4513' },
                    { x: 450, y: 300, width: 100, height: 20, color: '#8b4513' },
                    { x: 600, y: 360, width: 50, height: 20, color: '#8b4513' },
                    { x: 700, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 800, y: 480, width: 50, height: 20, color: '#8b4513' },
                    { x: 900, y: 550, width: 100, height: 50, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 120, y: 530, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 220, y: 460, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 320, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 570, y: 400, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 670, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 870, y: 530, width: 20, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 450, y: 130, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 130, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 380, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 630, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 6: Mirror maze
            {
                name: "Mirror Paths",
                platforms: [
                    { x: 0, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 130, y: 480, width: 60, height: 20, color: '#8b4513' },
                    { x: 240, y: 420, width: 60, height: 20, color: '#8b4513' },
                    { x: 350, y: 360, width: 60, height: 20, color: '#8b4513' },
                    { x: 460, y: 300, width: 80, height: 20, color: '#8b4513' },
                    { x: 590, y: 360, width: 60, height: 20, color: '#8b4513' },
                    { x: 700, y: 420, width: 60, height: 20, color: '#8b4513' },
                    { x: 810, y: 480, width: 60, height: 20, color: '#8b4513' },
                    { x: 920, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 100, y: 530, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 210, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 320, y: 400, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 560, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 670, y: 460, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 880, y: 530, width: 20, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 450, y: 130, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 130, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 40, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 960, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 490, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 510, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 7: Tower climb
            {
                name: "Spiral Tower",
                platforms: [
                    { x: 0, y: 550, width: 150, height: 50, color: '#8b4513' },
                    { x: 200, y: 480, width: 80, height: 20, color: '#8b4513' },
                    { x: 330, y: 420, width: 80, height: 20, color: '#8b4513' },
                    { x: 460, y: 360, width: 80, height: 20, color: '#8b4513' },
                    { x: 590, y: 300, width: 80, height: 20, color: '#8b4513' },
                    { x: 720, y: 240, width: 80, height: 20, color: '#8b4513' },
                    { x: 580, y: 180, width: 80, height: 20, color: '#8b4513' },
                    { x: 440, y: 120, width: 80, height: 20, color: '#8b4513' },
                    { x: 400, y: 60, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 170, y: 530, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 300, y: 460, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 430, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 560, y: 340, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 690, y: 280, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 550, y: 220, width: 20, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 450, y: 10, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 10, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 230, y: 460, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 490, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 620, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 470, y: 100, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' }
                ]
            },
            
            // Level 8: Hazard highway
            {
                name: "Dangerous Highway",
                platforms: [
                    { x: 0, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 130, y: 480, width: 50, height: 20, color: '#8b4513' },
                    { x: 230, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 330, y: 360, width: 50, height: 20, color: '#8b4513' },
                    { x: 430, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 530, y: 480, width: 50, height: 20, color: '#8b4513' },
                    { x: 630, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 730, y: 360, width: 50, height: 20, color: '#8b4513' },
                    { x: 830, y: 420, width: 50, height: 20, color: '#8b4513' },
                    { x: 920, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 350, y: 240, width: 300, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 100, y: 530, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 200, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 300, y: 400, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 400, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 500, y: 520, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 600, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 700, y: 400, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 800, y: 460, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 900, y: 530, width: 20, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 450, y: 190, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 190, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 40, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 160, y: 460, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 360, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 560, y: 460, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 760, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 960, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 9: Great divide
            {
                name: "The Great Divide",
                platforms: [
                    { x: 0, y: 550, width: 120, height: 50, color: '#8b4513' },
                    { x: 180, y: 450, width: 80, height: 150, color: '#8b4513' },
                    { x: 320, y: 380, width: 60, height: 20, color: '#8b4513' },
                    { x: 440, y: 320, width: 120, height: 20, color: '#8b4513' },
                    { x: 620, y: 380, width: 60, height: 20, color: '#8b4513' },
                    { x: 740, y: 450, width: 80, height: 150, color: '#8b4513' },
                    { x: 880, y: 550, width: 120, height: 50, color: '#8b4513' },
                    { x: 120, y: 280, width: 80, height: 20, color: '#8b4513' },
                    { x: 800, y: 280, width: 80, height: 20, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 280, y: 580, width: 440, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 350, y: 360, width: 30, height: 20, type: 'water', color: '#0074d9' },
                    { x: 590, y: 360, width: 30, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 450, y: 130, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 130, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 210, y: 430, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 770, y: 430, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 150, y: 260, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 830, y: 260, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' }
                ]
            },
            
            // Level 10: Switch symphony
            {
                name: "Switch Symphony",
                platforms: [
                    { x: 0, y: 550, width: 100, height: 50, color: '#8b4513' },
                    { x: 150, y: 480, width: 60, height: 20, color: '#8b4513' },
                    { x: 260, y: 420, width: 60, height: 20, color: '#8b4513' },
                    { x: 370, y: 360, width: 60, height: 20, color: '#8b4513' },
                    { x: 480, y: 300, width: 60, height: 20, color: '#8b4513' },
                    { x: 590, y: 360, width: 60, height: 20, color: '#8b4513' },
                    { x: 700, y: 420, width: 60, height: 20, color: '#8b4513' },
                    { x: 810, y: 480, width: 60, height: 20, color: '#8b4513' },
                    { x: 900, y: 550, width: 100, height: 50, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 120, y: 530, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 230, y: 460, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 340, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 450, y: 340, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 560, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 670, y: 460, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 880, y: 530, width: 20, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 450, y: 130, width: 35, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 515, y: 130, width: 35, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 50, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 180, y: 460, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 290, y: 400, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 400, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 510, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 620, y: 340, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 730, y: 400, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 950, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' }
                ]
            },
            // Level 11: The gauntlet
            {
                name: "Ultimate Gauntlet",
                platforms: [
                    { x: 0, y: 550, width: 60, height: 50, color: '#8b4513' },
                    { x: 100, y: 500, width: 40, height: 20, color: '#8b4513' },
                    { x: 180, y: 450, width: 40, height: 20, color: '#8b4513' },
                    { x: 260, y: 400, width: 40, height: 20, color: '#8b4513' },
                    { x: 340, y: 350, width: 40, height: 20, color: '#8b4513' },
                    { x: 420, y: 300, width: 40, height: 20, color: '#8b4513' },
                    { x: 500, y: 250, width: 40, height: 20, color: '#8b4513' },
                    { x: 580, y: 300, width: 40, height: 20, color: '#8b4513' },
                    { x: 660, y: 350, width: 40, height: 20, color: '#8b4513' },
                    { x: 740, y: 400, width: 40, height: 20, color: '#8b4513' },
                    { x: 820, y: 450, width: 40, height: 20, color: '#8b4513' },
                    { x: 900, y: 500, width: 40, height: 20, color: '#8b4513' },
                    { x: 940, y: 550, width: 60, height: 50, color: '#8b4513' },
                    { x: 450, y: 150, width: 100, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 70, y: 480, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 150, y: 480, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 230, y: 430, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 310, y: 380, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 390, y: 330, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 470, y: 280, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 550, y: 330, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 630, y: 380, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 710, y: 430, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 790, y: 480, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 870, y: 480, width: 20, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 475, y: 100, width: 25, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 500, y: 100, width: 25, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 30, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 120, y: 480, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 280, y: 380, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 440, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 520, y: 230, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 600, y: 280, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 760, y: 380, width: 20, height: 20, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 970, y: 530, width: 20, height: 20, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 12: Cooperation chambers
            {
                name: "Cooperation Chambers",
                platforms: [
                    { x: 0, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 120, y: 480, width: 40, height: 70, color: '#8b4513' },
                    { x: 200, y: 420, width: 40, height: 130, color: '#8b4513' },
                    { x: 280, y: 380, width: 60, height: 20, color: '#8b4513' },
                    { x: 380, y: 320, width: 240, height: 20, color: '#8b4513' },
                    { x: 660, y: 380, width: 60, height: 20, color: '#8b4513' },
                    { x: 760, y: 420, width: 40, height: 130, color: '#8b4513' },
                    { x: 840, y: 480, width: 40, height: 70, color: '#8b4513' },
                    { x: 920, y: 550, width: 80, height: 50, color: '#8b4513' },
                    { x: 450, y: 220, width: 100, height: 20, color: '#8b4513' },
                    { x: 475, y: 120, width: 50, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 100, y: 530, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 180, y: 460, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 250, y: 400, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 350, y: 360, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 640, y: 360, width: 20, height: 20, type: 'water', color: '#0074d9' },
                    { x: 730, y: 400, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 820, y: 460, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 900, y: 530, width: 15, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 485, y: 70, width: 15, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 500, y: 70, width: 15, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 40, y: 530, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 140, y: 460, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 220, y: 400, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 310, y: 360, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 470, y: 300, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 515, y: 300, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 690, y: 360, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 780, y: 400, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 860, y: 460, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 960, y: 530, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 13: Elemental crucible
            {
                name: "Elemental Crucible",
                platforms: [
                    { x: 0, y: 550, width: 60, height: 50, color: '#8b4513' },
                    { x: 90, y: 500, width: 30, height: 20, color: '#8b4513' },
                    { x: 150, y: 460, width: 30, height: 20, color: '#8b4513' },
                    { x: 210, y: 420, width: 30, height: 20, color: '#8b4513' },
                    { x: 270, y: 380, width: 30, height: 20, color: '#8b4513' },
                    { x: 330, y: 340, width: 30, height: 20, color: '#8b4513' },
                    { x: 390, y: 300, width: 60, height: 20, color: '#8b4513' },
                    { x: 480, y: 260, width: 80, height: 20, color: '#8b4513' },
                    { x: 590, y: 300, width: 60, height: 20, color: '#8b4513' },
                    { x: 680, y: 340, width: 30, height: 20, color: '#8b4513' },
                    { x: 740, y: 380, width: 30, height: 20, color: '#8b4513' },
                    { x: 800, y: 420, width: 30, height: 20, color: '#8b4513' },
                    { x: 860, y: 460, width: 30, height: 20, color: '#8b4513' },
                    { x: 920, y: 500, width: 30, height: 20, color: '#8b4513' },
                    { x: 970, y: 550, width: 30, height: 50, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 20, color: '#8b4513' },
                    { x: 475, y: 120, width: 50, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 70, y: 480, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 130, y: 440, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 190, y: 400, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 250, y: 360, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 310, y: 320, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 370, y: 280, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 570, y: 280, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 660, y: 320, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 720, y: 360, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 780, y: 400, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 840, y: 440, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 900, y: 480, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 430, y: 160, width: 20, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 550, y: 160, width: 20, height: 20, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 485, y: 70, width: 15, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 500, y: 70, width: 15, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 30, y: 530, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 105, y: 480, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 165, y: 440, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 225, y: 400, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 285, y: 360, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 345, y: 320, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 415, y: 280, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 510, y: 240, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 525, y: 240, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 615, y: 280, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 695, y: 320, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 755, y: 360, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 815, y: 400, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 875, y: 440, width: 15, height: 15, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 935, y: 480, width: 15, height: 15, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 14: Trial of elements
            {
                name: "Trial of Elements",
                platforms: [
                    { x: 0, y: 550, width: 50, height: 50, color: '#8b4513' },
                    { x: 70, y: 520, width: 25, height: 20, color: '#8b4513' },
                    { x: 115, y: 490, width: 25, height: 20, color: '#8b4513' },
                    { x: 160, y: 460, width: 25, height: 20, color: '#8b4513' },
                    { x: 205, y: 430, width: 25, height: 20, color: '#8b4513' },
                    { x: 250, y: 400, width: 25, height: 20, color: '#8b4513' },
                    { x: 295, y: 370, width: 25, height: 20, color: '#8b4513' },
                    { x: 340, y: 340, width: 25, height: 20, color: '#8b4513' },
                    { x: 385, y: 310, width: 25, height: 20, color: '#8b4513' },
                    { x: 430, y: 280, width: 50, height: 20, color: '#8b4513' },
                    { x: 500, y: 250, width: 80, height: 20, color: '#8b4513' },
                    { x: 600, y: 280, width: 50, height: 20, color: '#8b4513' },
                    { x: 670, y: 310, width: 25, height: 20, color: '#8b4513' },
                    { x: 715, y: 340, width: 25, height: 20, color: '#8b4513' },
                    { x: 760, y: 370, width: 25, height: 20, color: '#8b4513' },
                    { x: 805, y: 400, width: 25, height: 20, color: '#8b4513' },
                    { x: 850, y: 430, width: 25, height: 20, color: '#8b4513' },
                    { x: 895, y: 460, width: 25, height: 20, color: '#8b4513' },
                    { x: 940, y: 490, width: 25, height: 20, color: '#8b4513' },
                    { x: 985, y: 520, width: 15, height: 20, color: '#8b4513' },
                    { x: 350, y: 180, width: 300, height: 20, color: '#8b4513' },
                    { x: 450, y: 120, width: 100, height: 20, color: '#8b4513' },
                    { x: 485, y: 70, width: 30, height: 20, color: '#8b4513' }
                ],
                hazards: [
                    { x: 55, y: 500, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 100, y: 470, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 145, y: 440, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 190, y: 410, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 235, y: 380, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 280, y: 350, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 325, y: 320, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 370, y: 290, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 415, y: 260, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 485, y: 230, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 565, y: 230, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 655, y: 260, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 700, y: 290, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 745, y: 320, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 790, y: 350, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 835, y: 380, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 880, y: 410, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 925, y: 440, width: 10, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 970, y: 470, width: 10, height: 20, type: 'water', color: '#0074d9' },
                    { x: 380, y: 160, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 425, y: 160, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 505, y: 160, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 575, y: 160, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 620, y: 160, width: 15, height: 20, type: 'fire', color: '#ff4136' },
                    { x: 470, y: 100, width: 15, height: 20, type: 'water', color: '#0074d9' },
                    { x: 515, y: 100, width: 15, height: 20, type: 'fire', color: '#ff4136' }
                ],
                doors: [
                    { x: 490, y: 20, width: 10, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 500, y: 20, width: 10, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 25, y: 530, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 85, y: 500, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 130, y: 470, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 175, y: 440, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 220, y: 410, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 265, y: 380, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 310, y: 350, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 355, y: 320, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 400, y: 290, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 450, y: 260, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 520, y: 230, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 540, y: 230, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 620, y: 260, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 685, y: 290, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 730, y: 320, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 775, y: 350, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 820, y: 380, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 865, y: 410, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 910, y: 440, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 955, y: 470, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            },
            
            // Level 15: Final challenge
            {
                name: "Final Challenge",
                platforms: [
                    { x: 0, y: 550, width: 40, height: 50, color: '#8b4513' },
                    { x: 60, y: 520, width: 20, height: 15, color: '#8b4513' },
                    { x: 100, y: 500, width: 20, height: 15, color: '#8b4513' },
                    { x: 140, y: 480, width: 20, height: 15, color: '#8b4513' },
                    { x: 180, y: 460, width: 20, height: 15, color: '#8b4513' },
                    { x: 220, y: 440, width: 20, height: 15, color: '#8b4513' },
                    { x: 260, y: 420, width: 20, height: 15, color: '#8b4513' },
                    { x: 300, y: 400, width: 20, height: 15, color: '#8b4513' },
                    { x: 340, y: 380, width: 20, height: 15, color: '#8b4513' },
                    { x: 380, y: 360, width: 20, height: 15, color: '#8b4513' },
                    { x: 420, y: 340, width: 20, height: 15, color: '#8b4513' },
                    { x: 460, y: 320, width: 30, height: 15, color: '#8b4513' },
                    { x: 510, y: 300, width: 40, height: 15, color: '#8b4513' },
                    { x: 570, y: 320, width: 30, height: 15, color: '#8b4513' },
                    { x: 620, y: 340, width: 20, height: 15, color: '#8b4513' },
                    { x: 660, y: 360, width: 20, height: 15, color: '#8b4513' },
                    { x: 700, y: 380, width: 20, height: 15, color: '#8b4513' },
                    { x: 740, y: 400, width: 20, height: 15, color: '#8b4513' },
                    { x: 780, y: 420, width: 20, height: 15, color: '#8b4513' },
                    { x: 820, y: 440, width: 20, height: 15, color: '#8b4513' },
                    { x: 860, y: 460, width: 20, height: 15, color: '#8b4513' },
                    { x: 900, y: 480, width: 20, height: 15, color: '#8b4513' },
                    { x: 940, y: 500, width: 20, height: 15, color: '#8b4513' },
                    { x: 980, y: 520, width: 20, height: 15, color: '#8b4513' },
                    { x: 960, y: 550, width: 40, height: 50, color: '#8b4513' },
                    { x: 300, y: 250, width: 400, height: 15, color: '#8b4513' },
                    { x: 400, y: 180, width: 200, height: 15, color: '#8b4513' },
                    { x: 450, y: 120, width: 100, height: 15, color: '#8b4513' },
                    { x: 485, y: 70, width: 30, height: 15, color: '#8b4513' },
                    { x: 495, y: 30, width: 10, height: 15, color: '#8b4513' }
                ],
                hazards: [
                    { x: 45, y: 500, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 85, y: 480, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 125, y: 460, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 165, y: 440, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 205, y: 420, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 245, y: 400, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 285, y: 380, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 325, y: 360, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 365, y: 340, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 405, y: 320, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 445, y: 300, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 495, y: 280, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 535, y: 280, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 555, y: 300, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 605, y: 320, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 645, y: 340, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 685, y: 360, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 725, y: 380, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 765, y: 400, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 805, y: 420, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 845, y: 440, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 885, y: 460, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 925, y: 480, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 965, y: 500, width: 10, height: 15, type: 'water', color: '#0074d9' },
                    { x: 330, y: 230, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 370, y: 230, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 430, y: 230, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 490, y: 230, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 550, y: 230, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 610, y: 230, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 655, y: 230, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 420, y: 160, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 465, y: 160, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 520, y: 160, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 565, y: 160, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 470, y: 100, width: 15, height: 15, type: 'water', color: '#0074d9' },
                    { x: 515, y: 100, width: 15, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 475, y: 50, width: 10, height: 15, type: 'fire', color: '#ff4136' },
                    { x: 520, y: 50, width: 10, height: 15, type: 'water', color: '#0074d9' }
                ],
                doors: [
                    { x: 497, y: -20, width: 6, height: 50, type: 'fire', color: '#ff4757' },
                    { x: 497, y: -20, width: 6, height: 50, type: 'water', color: '#3742fa' }
                ],
                switches: [
                    { x: 20, y: 530, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 70, y: 500, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 110, y: 480, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 150, y: 460, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 190, y: 440, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 230, y: 420, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 270, y: 400, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 310, y: 380, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 350, y: 360, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 390, y: 340, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 430, y: 320, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 470, y: 300, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 520, y: 280, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 530, y: 280, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 580, y: 300, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 630, y: 320, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 670, y: 340, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 710, y: 360, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 750, y: 380, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 790, y: 400, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 830, y: 420, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 870, y: 440, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 910, y: 460, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' },
                    { x: 950, y: 480, width: 10, height: 10, activated: false, requiredPlayer: 'fire', color: '#ff8a80' },
                    { x: 980, y: 500, width: 10, height: 10, activated: false, requiredPlayer: 'water', color: '#82b1ff' }
                ]
            }
        ];   
      
      let currentLevelData = levels[currentLevel - 1];

        // GLOBAL FUNCTIONS
        window.createRoom = function() {
            console.log("üÜï Create room button clicked");
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                showStatus('Please enter your name!');
                return;
            }
            
            const roomId = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('roomId').value = roomId;
            showStatus(`Creating room ${roomId}...`);
            joinGame();
        };

        window.joinGame = function() {
            console.log("üö™ Join game function called");
            const playerName = document.getElementById('playerName').value.trim();
            const roomId = document.getElementById('roomId').value.trim().toUpperCase();
            
            if (!playerName || !roomId) {
                showStatus('Please enter both your name and room ID!');
                return;
            }

            // Disconnect existing socket
            if (socket && socket.connected) {
                socket.disconnect();
            }

            showStatus('Connecting to server...');
            
            socket = io({
                transports: ['websocket'], // WebSocket only for best performance
                timeout: 10000,
                forceNew: true,
                upgrade: false, // Don't try to upgrade transport
                compression: false // Disable compression for speed
            });

            socket.on('connect', () => {
                console.log('üîå Connected to server');
                showStatus('Connected! Joining room...');
                socket.emit('joinRoom', { roomId: roomId, playerName: playerName });
                
                // Start ping monitoring
                startPingMonitoring();
            });

            socket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                showStatus('‚ùå Failed to connect to server. Please refresh and try again.');
            });

            socket.on('playerAssigned', (data) => {
                myPlayerType = data.playerType;
                console.log(`üéÆ Assigned as ${data.playerType} player`);
                
                // Set player colors and positions
                if (myPlayerType === 'fire') {
                    myPlayer.color = '#ff4757';
                    otherPlayer.color = '#3742fa';
                    myPlayer.x = 50;
                    otherPlayer.x = 100;
                } else {
                    myPlayer.color = '#3742fa';
                    otherPlayer.color = '#ff4757';
                    myPlayer.x = 100;
                    otherPlayer.x = 50;
                }
                
                showStatus(data.playersCount === 2 
                    ? `You are the ${data.playerType} player! Starting game...`
                    : `You are the ${data.playerType} player! Waiting for partner... (Room: ${data.roomId})`);
                
                updatePlayerIndicator(data);
                
                if (data.playersCount === 2) {
                    setTimeout(startGame, 1000);
                }
            });

            socket.on('playerJoined', (data) => {
                console.log(`ü§ù Partner joined!`);
                showStatus('Partner joined! Starting game...');
                setTimeout(startGame, 1000);
            });

            socket.on('roomFull', () => {
                showStatus('‚ùå Room is full! Try a different room ID.');
            });

            socket.on('playerLeft', (data) => {
                showStatus(`üòû Partner left the game. Waiting for new partner...`);
                if (gameInitialized) {
                    document.getElementById('gameScreen').style.display = 'none';
                    document.getElementById('connectionScreen').style.display = 'flex';
                    gameInitialized = false;
                }
            });

            // IMPROVED: Receive inputs and apply immediately
            socket.on('playerInput', (data) => {
                if (data.playerType !== myPlayerType) {
                    // Apply input to other player instantly for zero-lag feel
                    otherPlayer.keys = { ...data.keys };
                }
            });

            // FIXED: Only sync other player's position, not my own
            socket.on('playerPosition', (data) => {
                if (data.playerType !== myPlayerType) {
                    // Only update the OTHER player's position
                    otherPlayer.x = data.x;
                    otherPlayer.y = data.y;
                    otherPlayer.velX = data.velX || 0;
                    otherPlayer.velY = data.velY || 0;
                }
                // Remove any reconciliation for my own player - let client handle it
            });

            socket.on('levelComplete', () => {
                document.getElementById('levelComplete').style.display = 'block';
                gameState = 'complete';
            });

            socket.on('restartLevel', () => {
                resetLevel();
            });

            socket.on('nextLevel', () => {
                if (currentLevel < levels.length) {
                    currentLevel++;
                    currentLevelData = levels[currentLevel - 1];
                    document.getElementById('levelInfo').textContent = `Level ${currentLevel} - Get both players to their colored doors!`;
                }
                resetLevel();
                document.getElementById('levelComplete').style.display = 'none';
                gameState = 'playing';
            });

            socket.on('disconnect', (reason) => {
                console.log('üîå Disconnected:', reason);
                showStatus('üîå Disconnected from server. Refresh to reconnect.');
                if (gameInitialized) {
                    document.getElementById('gameScreen').style.display = 'none';
                    document.getElementById('connectionScreen').style.display = 'flex';
                    gameInitialized = false;
                }
            });

            // Ping response
            socket.on('pong', () => {
                ping = Date.now() - lastPingTime;
                document.getElementById('pingValue').textContent = ping;
            });
        };

        window.nextLevel = function() {
            if (currentLevel < levels.length) {
                currentLevel++;
                currentLevelData = levels[currentLevel - 1];
                document.getElementById('levelInfo').textContent = `Level ${currentLevel} - Get both players to their colored doors!`;
                resetLevel();
            } else {
                showStatus('üéâ Congratulations! You completed all levels together! üéâ');
                currentLevel = 1;
                currentLevelData = levels[0];
                document.getElementById('levelInfo').textContent = 'Level 1 - Get both players to their colored doors!';
                resetLevel();
            }
            
            if (socket && socket.connected) {
                socket.emit('nextLevel');
            }
            document.getElementById('levelComplete').style.display = 'none';
            gameState = 'playing';
        };

        window.restartLevel = function() {
            document.getElementById('levelComplete').style.display = 'none';
            resetLevel();
            // Send restart command to server
            if (socket && socket.connected) {
                socket.emit('restartLevel');
            }
        };

        function showStatus(message) {
            document.getElementById('statusMessage').textContent = message;
            console.log('Status:', message);
        }

        function updatePlayerIndicator(data) {
            document.getElementById('playerInfo').innerHTML = `You: ${myPlayerType === 'fire' ? 'üî•' : 'üíß'} ${myPlayerType}`;
            document.getElementById('roomInfo').innerHTML = `Room: ${data.roomId}<br>Players: ${data.playersCount}/2`;
            document.getElementById('playerIndicator').style.display = 'block';
            
            document.getElementById('fireControls').classList.remove('my-controls');
            document.getElementById('waterControls').classList.remove('my-controls');
            
            if (myPlayerType === 'fire') {
                document.getElementById('fireControls').classList.add('my-controls');
            } else if (myPlayerType === 'water') {
                document.getElementById('waterControls').classList.add('my-controls');
            }
        }

        function startGame() {
            console.log('üéÆ Starting ultra-smooth game...');
            document.getElementById('connectionScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('networkInfo').style.display = 'block';
            gameInitialized = true;
            
            resetLevel();
            
            // Start the game loop with proper timing
            requestAnimationFrame(gameLoop);
        }

        function startPingMonitoring() {
            setInterval(() => {
                if (socket && socket.connected) {
                    lastPingTime = Date.now();
                    socket.emit('ping');
                }
            }, 1000);
        }

        // Removed complex reconciliation - now using pure client authority
        // Each client is authoritative over their own player movement

        // ULTRA-OPTIMIZED INPUT HANDLING - Immediate response, smart sending
        const keys = {};
        let inputChanged = false;

        document.addEventListener('keydown', (e) => {
            if (!gameInitialized || !myPlayerType) return;
            
            const key = e.key.toLowerCase();
            if (keys[key]) return; // Already pressed, ignore repeat
            
            keys[key] = true;
            
            if ((myPlayerType === 'fire' && ['w', 'a', 's', 'd'].includes(key)) ||
                (myPlayerType === 'water' && ['arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key))) {
                e.preventDefault();
                inputChanged = true;
                updateMyPlayerInput();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!gameInitialized || !myPlayerType) return;
            
            const key = e.key.toLowerCase();
            if (!keys[key]) return; // Already released, ignore
            
            keys[key] = false;
            
            if ((myPlayerType === 'fire' && ['w', 'a', 's', 'd'].includes(key)) ||
                (myPlayerType === 'water' && ['arrowup', 'arrowdown', 'arrowleft', 'arrowright'].includes(key))) {
                e.preventDefault();
                inputChanged = true;
                updateMyPlayerInput();
            }
        });

        function updateMyPlayerInput() {
            // Update player keys immediately - no delay
            if (myPlayerType === 'fire') {
                myPlayer.keys.left = keys['a'] || false;
                myPlayer.keys.right = keys['d'] || false;
                myPlayer.keys.up = keys['w'] || false;
            } else if (myPlayerType === 'water') {
                myPlayer.keys.left = keys['arrowleft'] || false;
                myPlayer.keys.right = keys['arrowright'] || false;
                myPlayer.keys.up = keys['arrowup'] || false;
            }
        }

        // OPTIMIZED: Send inputs only when they change, but immediately
        function sendInputToServer() {
            if (inputChanged && socket && socket.connected) {
                inputChanged = false;
                const inputData = {
                    keys: { ...myPlayer.keys },
                    timestamp: Date.now()
                };
                
                socket.emit('playerInput', inputData);
            }
        }

        // PHYSICS FUNCTIONS
        function checkCollision(rect1, rect2) {
            return rect1.x < rect2.x + rect2.width &&
                   rect1.x + rect1.width > rect2.x &&
                   rect1.y < rect2.y + rect2.height &&
                   rect1.y + rect1.height > rect2.y;
        }

        // SIMPLIFIED PHYSICS WITH HAZARD DETECTION
        function updateMyPlayer() {
            const player = myPlayer;
            
            // Horizontal movement
            if (player.keys.left) {
                player.velX -= player.acceleration;
                if (player.velX < -player.maxSpeed) player.velX = -player.maxSpeed;
            } else if (player.keys.right) {
                player.velX += player.acceleration;
                if (player.velX > player.maxSpeed) player.velX = player.maxSpeed;
            } else {
                player.velX *= player.friction;
                if (Math.abs(player.velX) < 0.1) player.velX = 0;
            }
            
            player.x += player.velX;
            
            // Platform collisions - horizontal
            player.onWall = false;
            for (let platform of currentLevelData.platforms) {
                if (checkCollision(player, platform)) {
                    if (player.velX > 0) {
                        player.x = platform.x - player.width;
                    } else if (player.velX < 0) {
                        player.x = platform.x + platform.width;
                    }
                    player.velX = 0;
                    player.onWall = true;
                    break;
                }
            }
            
            // Player-to-player collision - horizontal
            if (checkCollision(player, otherPlayer)) {
                if (player.velX > 0) {
                    player.x = otherPlayer.x - player.width;
                } else if (player.velX < 0) {
                    player.x = otherPlayer.x + otherPlayer.width;
                }
                player.velX = 0;
            }
            
            // Jumping
            if (player.keys.up && (player.onGround || player.onWall)) {
                player.velY = -player.jumpPower;
                player.jumping = true;
                player.onGround = false;
            }
            
            // Variable jump height
            if (!player.keys.up && player.jumping && player.velY < -2) {
                player.velY *= 0.7;
            }
            
            // Gravity
            player.velY += player.gravity;
            if (player.velY > player.maxFallSpeed) {
                player.velY = player.maxFallSpeed;
            }
            
            player.y += player.velY;
            
            // Platform collisions - vertical
            player.onGround = false;
            for (let platform of currentLevelData.platforms) {
                if (checkCollision(player, platform)) {
                    if (player.velY > 0) {
                        player.y = platform.y - player.height;
                        player.velY = 0;
                        player.onGround = true;
                        player.jumping = false;
                    } else if (player.velY < 0) {
                        player.y = platform.y + platform.height;
                        player.velY = 0;
                    }
                    break;
                }
            }
            
            // Player-to-player collision - vertical
            if (checkCollision(player, otherPlayer)) {
                if (player.velY > 0 && player.y < otherPlayer.y) {
                    player.y = otherPlayer.y - player.height;
                    player.velY = 0;
                    player.onGround = true;
                    player.jumping = false;
                } else if (player.velY < 0 && player.y > otherPlayer.y) {
                    player.y = otherPlayer.y + otherPlayer.height;
                    player.velY = 0;
                }
            }
            
            // HAZARD COLLISION DETECTION
            for (let hazard of currentLevelData.hazards) {
                if (checkCollision(player, hazard)) {
                    // Check if this hazard is deadly for this player type
                    if ((myPlayerType === 'fire' && hazard.type === 'water') ||
                        (myPlayerType === 'water' && hazard.type === 'fire')) {
                        console.log(`üíÄ ${myPlayerType} player hit ${hazard.type} hazard - resetting level`);
                        resetLevel();
                        return; // Exit early since we're resetting
                    }
                }
            }
            
            // SWITCH INTERACTION - Check if player is touching switches
            if (currentLevelData.switches) {
                for (let switchObj of currentLevelData.switches) {
                    if (checkCollision(player, switchObj)) {
                        // Check if this player can activate this switch
                        if (switchObj.requiredPlayer === myPlayerType && !switchObj.activated) {
                            switchObj.activated = true;
                            console.log(`üîÑ ${myPlayerType} player activated switch`);
                        }
                    }
                }
            }
            
            // Screen boundaries
            if (player.x < 0) {
                player.x = 0;
                player.velX = 0;
            }
            if (player.x + player.width > canvas.width) {
                player.x = canvas.width - player.width;
                player.velX = 0;
            }
            
            // Death by falling
            if (player.y > canvas.height + 100) {
                console.log(`üíÄ ${myPlayerType} player fell off screen - resetting level`);
                resetLevel();
            }
        }

        function updateOtherPlayer() {
            const player = otherPlayer;
            
            // Apply inputs received from server for immediate response
            if (player.keys.left || player.keys.right || player.keys.up) {
                // Horizontal movement
                if (player.keys.left) {
                    player.velX -= player.acceleration;
                    if (player.velX < -player.maxSpeed) player.velX = -player.maxSpeed;
                } else if (player.keys.right) {
                    player.velX += player.acceleration;
                    if (player.velX > player.maxSpeed) player.velX = player.maxSpeed;
                } else {
                    player.velX *= player.friction;
                    if (Math.abs(player.velX) < 0.1) player.velX = 0;
                }
                
                player.x += player.velX;
                
                // Platform collisions
                for (let platform of currentLevelData.platforms) {
                    if (checkCollision(player, platform)) {
                        if (player.velX > 0) {
                            player.x = platform.x - player.width;
                        } else if (player.velX < 0) {
                            player.x = platform.x + platform.width;
                        }
                        player.velX = 0;
                        break;
                    }
                }
                
                // Jumping
                if (player.keys.up && player.onGround) {
                    player.velY = -player.jumpPower;
                    player.jumping = true;
                    player.onGround = false;
                }
                
                // Gravity
                player.velY += player.gravity;
                if (player.velY > player.maxFallSpeed) {
                    player.velY = player.maxFallSpeed;
                }
                
                player.y += player.velY;
                
                // Vertical platform collisions
                player.onGround = false;
                for (let platform of currentLevelData.platforms) {
                    if (checkCollision(player, platform)) {
                        if (player.velY > 0) {
                            player.y = platform.y - player.height;
                            player.velY = 0;
                            player.onGround = true;
                            player.jumping = false;
                        } else if (player.velY < 0) {
                            player.y = platform.y + platform.height;
                            player.velY = 0;
                        }
                        break;
                    }
                }
                
                // HAZARD COLLISION FOR OTHER PLAYER
                for (let hazard of currentLevelData.hazards) {
                    if (checkCollision(player, hazard)) {
                        // Determine other player type
                        const otherPlayerType = myPlayerType === 'fire' ? 'water' : 'fire';
                        
                        // Check if this hazard is deadly for the other player
                        if ((otherPlayerType === 'fire' && hazard.type === 'water') ||
                            (otherPlayerType === 'water' && hazard.type === 'fire')) {
                            console.log(`üíÄ ${otherPlayerType} player hit ${hazard.type} hazard - resetting level`);
                            resetLevel();
                            return; // Exit early since we're resetting
                        }
                    }
                }
                
                // SWITCH INTERACTION FOR OTHER PLAYER
                if (currentLevelData.switches) {
                    for (let switchObj of currentLevelData.switches) {
                        if (checkCollision(player, switchObj)) {
                            const otherPlayerType = myPlayerType === 'fire' ? 'water' : 'fire';
                            // Check if other player can activate this switch
                            if (switchObj.requiredPlayer === otherPlayerType && !switchObj.activated) {
                                switchObj.activated = true;
                                console.log(`üîÑ ${otherPlayerType} player activated switch`);
                            }
                        }
                    }
                }
                
                // Screen boundaries
                if (player.x < 0) player.x = 0;
                if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
                
                // Death by falling for other player
                if (player.y > canvas.height + 100) {
                    const otherPlayerType = myPlayerType === 'fire' ? 'water' : 'fire';
                    console.log(`üíÄ ${otherPlayerType} player fell off screen - resetting level`);
                    resetLevel();
                }
            }
            // Removed interpolation - position updates come directly from server
        }

        // MINIMAL POSITION SENDING - Only for major corrections
        let positionSendCounter = 0;
        function sendMyPosition() {
            positionSendCounter++;
            if (positionSendCounter >= 20) { // Send every 20 frames (~3fps) - very minimal
                positionSendCounter = 0;
                if (socket && socket.connected) {
                    socket.emit('playerPosition', {
                        x: Math.round(myPlayer.x), // Round to reduce data
                        y: Math.round(myPlayer.y),
                        velX: Math.round(myPlayer.velX * 10) / 10, // One decimal
                        velY: Math.round(myPlayer.velY * 10) / 10
                    });
                }
            }
        }

        // RENDERING FUNCTIONS
        function drawLevel() {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87ceeb');
            gradient.addColorStop(1, '#98fb98');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw platforms
            for (let platform of currentLevelData.platforms) {
                ctx.fillStyle = platform.color;
                ctx.fillRect(platform.x, platform.y, platform.width, platform.height);
            }
            
            // Draw hazards
            for (let hazard of currentLevelData.hazards) {
                ctx.fillStyle = hazard.color;
                ctx.fillRect(hazard.x, hazard.y, hazard.width, hazard.height);
            }
            
            // Draw switches
            if (currentLevelData.switches) {
                for (let switchObj of currentLevelData.switches) {
                    // Change color based on activation
                    ctx.fillStyle = switchObj.activated ? '#4CAF50' : switchObj.color;
                    ctx.fillRect(switchObj.x, switchObj.y, switchObj.width, switchObj.height);
                    
                    // Add visual indicator
                    ctx.fillStyle = 'white';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(switchObj.activated ? '‚úì' : '‚óã', 
                               switchObj.x + switchObj.width/2, switchObj.y + switchObj.height/2 + 4);
                }
            }
            
            // Draw doors
            for (let door of currentLevelData.doors) {
                ctx.fillStyle = door.color;
                ctx.fillRect(door.x, door.y, door.width, door.height);
                
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(door.type === 'fire' ? 'üî•' : 'üíß', 
                           door.x + door.width/2, door.y + door.height/2 + 8);
            }
        }

        function drawPlayer(player, emoji) {
            // Shadow
            ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            ctx.fillRect(player.x + 2, player.y + player.height + 2, player.width, 4);
            
            // Player body
            ctx.fillStyle = player.color;
            ctx.fillRect(player.x, player.y, player.width, player.height);
            
            // Border
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.strokeRect(player.x, player.y, player.width, player.height);
            
            // Emoji
            ctx.fillStyle = 'white';
            ctx.font = '18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(emoji, player.x + player.width/2, player.y + player.height/2 + 5);
        }

        function checkWinCondition() {
            if (!currentLevelData || !currentLevelData.doors) return;
            
            // Check if all switches are activated (if any exist)
            let allSwitchesActivated = true;
            if (currentLevelData.switches && currentLevelData.switches.length > 0) {
                for (let switchObj of currentLevelData.switches) {
                    if (!switchObj.activated) {
                        allSwitchesActivated = false;
                        break;
                    }
                }
            }
            
            // Only proceed if all switches are activated
            if (!allSwitchesActivated) {
                return;
            }
            
            let myPlayerAtDoor = false;
            let otherPlayerAtDoor = false;
            
            for (let door of currentLevelData.doors) {
                // Check my player
                if ((myPlayerType === 'fire' && door.type === 'fire') || 
                    (myPlayerType === 'water' && door.type === 'water')) {
                    if (myPlayer.x < door.x + door.width &&
                        myPlayer.x + myPlayer.width > door.x &&
                        myPlayer.y < door.y + door.height &&
                        myPlayer.y + myPlayer.height > door.y) {
                        myPlayerAtDoor = true;
                    }
                }
                
                // Check other player
                if ((myPlayerType === 'fire' && door.type === 'water') || 
                    (myPlayerType === 'water' && door.type === 'fire')) {
                    if (otherPlayer.x < door.x + door.width &&
                        otherPlayer.x + otherPlayer.width > door.x &&
                        otherPlayer.y < door.y + door.height &&
                        otherPlayer.y + otherPlayer.height > door.y) {
                        otherPlayerAtDoor = true;
                    }
                }
            }
            
            if (myPlayerAtDoor && otherPlayerAtDoor && gameState === 'playing') {
                console.log('üéâ Level complete! Both players at doors and all switches activated');
                if (socket && socket.connected) {
                    socket.emit('levelComplete');
                }
                document.getElementById('levelComplete').style.display = 'block';
                gameState = 'complete';
            }
        }

        // SUPER OPTIMIZED GAME LOOP - Higher performance
        let lastTime = 0;
        function gameLoop(currentTime) {
            if (!gameInitialized) return;
            
            // Calculate delta time for smooth animation
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;
            
            // FPS calculation (less frequent)
            frameCount++;
            if (frameCount >= 120) { // Update every 2 seconds
                fps = Math.round(1000 / deltaTime);
                document.getElementById('fpsValue').textContent = fps;
                frameCount = 0;
            }
            
            if (gameState === 'playing') {
                // Update players
                updateMyPlayer();
                updateOtherPlayer();
                
                // Send input changes immediately (only when changed)
                sendInputToServer();
                
                // Send position updates very sparingly
                sendMyPosition();
                
                checkWinCondition();
            }
            
            // Render everything
            drawLevel();
            
            // Draw players with correct emojis
            if (myPlayerType === 'fire') {
                drawPlayer(myPlayer, 'üî•');
                drawPlayer(otherPlayer, 'üíß');
            } else {
                drawPlayer(myPlayer, 'üíß');
                drawPlayer(otherPlayer, 'üî•');
            }
            
            requestAnimationFrame(gameLoop);
        }

        function resetLevel() {
            // Reset my player to correct starting position
            myPlayer.x = myPlayerType === 'fire' ? 50 : 100;
            myPlayer.y = 522;
            myPlayer.velX = 0;
            myPlayer.velY = 0;
            myPlayer.onGround = false;
            myPlayer.jumping = false;
            myPlayer.keys = { left: false, right: false, up: false };
            
            // Reset other player to correct starting position  
            otherPlayer.x = myPlayerType === 'fire' ? 100 : 50;
            otherPlayer.y = 522;
            otherPlayer.velX = 0;
            otherPlayer.velY = 0;
            otherPlayer.onGround = false;
            otherPlayer.jumping = false;
            otherPlayer.keys = { left: false, right: false, up: false };
            
            // Clear buffers
            inputBuffer = [];
            sequenceNumber = 0;
            
            gameState = 'playing';
            
            // Don't send restart to server unless explicitly restarting
            console.log('Level reset - positions restored');
        }

        // Enter key support and initialization
        document.addEventListener('DOMContentLoaded', function() {
            const playerNameInput = document.getElementById('playerName');
            const roomIdInput = document.getElementById('roomId');
            
            playerNameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    roomIdInput.focus();
                }
            });
            
            roomIdInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    window.joinGame();
                }
            });
            
            playerNameInput.focus();
        });

        // Visibility API for performance optimization
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Reduce update frequency when tab is not visible
                console.log('Tab hidden - reducing update frequency');
            } else {
                // Resume normal frequency when tab becomes visible
                console.log('Tab visible - resuming normal frequency');
            }
        });

        console.log("üéÆ Elemental Duo - Ultra Smooth Edition v4.0 Ready!");
    </script>
</body>
</html>